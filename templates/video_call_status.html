{% extends "base.html" %}

{% block title %}Video Call System Status - MindFull Horizon{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Video Call System Status</h1>
                    <p class="text-gray-600 mt-2">Monitor and test video calling functionality</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="runSystemTest()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Run System Test
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- System Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- WebRTC Support -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div id="webrtcIcon" class="bg-gray-100 rounded-full p-3 mr-4">
                        <i class="fas fa-video text-gray-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">WebRTC Support</p>
                        <p id="webrtcStatus" class="text-lg font-bold text-gray-900">Checking...</p>
                    </div>
                </div>
            </div>
            
            <!-- Camera Access -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div id="cameraIcon" class="bg-gray-100 rounded-full p-3 mr-4">
                        <i class="fas fa-camera text-gray-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Camera Access</p>
                        <p id="cameraStatus" class="text-lg font-bold text-gray-900">Checking...</p>
                    </div>
                </div>
            </div>
            
            <!-- Microphone Access -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div id="micIcon" class="bg-gray-100 rounded-full p-3 mr-4">
                        <i class="fas fa-microphone text-gray-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Microphone Access</p>
                        <p id="micStatus" class="text-lg font-bold text-gray-900">Checking...</p>
                    </div>
                </div>
            </div>
            
            <!-- Network Connection -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div id="networkIcon" class="bg-gray-100 rounded-full p-3 mr-4">
                        <i class="fas fa-wifi text-gray-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Network Status</p>
                        <p id="networkStatus" class="text-lg font-bold text-gray-900">Checking...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- User Information -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-xl font-semibold mb-4">User Information</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">User Role:</span>
                        <span class="font-medium">{{ session.user_role|title }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Institution:</span>
                        <span class="font-medium">{{ session.user_institution or 'Not Set' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Available Providers:</span>
                        <span id="providersCount" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Call History:</span>
                        <span id="callsCount" class="font-medium">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Browser Information -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-xl font-semibold mb-4">Browser Information</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Browser:</span>
                        <span id="browserName" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Platform:</span>
                        <span id="platformName" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Screen Resolution:</span>
                        <span id="screenRes" class="font-medium">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Connection Type:</span>
                        <span id="connectionType" class="font-medium">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h3 class="text-xl font-semibold mb-4">System Test Results</h3>
            <div id="testResults" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-flask text-3xl mb-3"></i>
                    <p>Click "Run System Test" to check video call functionality</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% if session.user_role == 'patient' %}
                <button onclick="testProviderSelection()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors">
                    <i class="fas fa-user-md mr-2"></i>Test Provider Selection
                </button>
                {% endif %}
                
                <button onclick="testMediaDevices()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors">
                    <i class="fas fa-camera mr-2"></i>Test Camera & Microphone
                </button>
                
                <a href="{{ url_for('call_history') }}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition-colors text-center">
                    <i class="fas fa-history mr-2"></i>View Call History
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Test Media Modal -->
<div id="mediaTestModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Media Devices Test</h3>
            <button onclick="closeMediaTest()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Video Preview -->
            <div class="bg-black rounded-lg overflow-hidden" style="height: 300px;">
                <video id="testVideo" class="w-full h-full object-cover" autoplay playsinline muted></video>
            </div>
            
            <!-- Audio Level -->
            <div>
                <label class="text-sm font-medium text-gray-700">Microphone Level</label>
                <div class="mt-2 bg-gray-200 rounded-full h-4">
                    <div id="audioLevel" class="bg-green-500 h-4 rounded-full transition-all duration-100" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex justify-between items-center pt-4">
                <div class="space-x-2">
                    <button id="toggleVideo" onclick="toggleTestVideo()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-video"></i> Toggle Video
                    </button>
                    <button id="toggleAudio" onclick="toggleTestAudio()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-microphone"></i> Toggle Audio
                    </button>
                </div>
                <button onclick="closeMediaTest()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    Close Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let testStream = null;
let audioContext = null;
let analyser = null;

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    checkSystemCapabilities();
    loadUserData();
    getBrowserInfo();
});

async function checkSystemCapabilities() {
    // Check WebRTC support
    if (window.RTCPeerConnection) {
        updateStatus('webrtc', 'Supported', 'success');
    } else {
        updateStatus('webrtc', 'Not Supported', 'error');
    }
    
    // Check media devices
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        try {
            // Test camera
            const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            updateStatus('camera', 'Available', 'success');
            videoStream.getTracks().forEach(track => track.stop());
            
            // Test microphone
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            updateStatus('mic', 'Available', 'success');
            audioStream.getTracks().forEach(track => track.stop());
        } catch (error) {
            if (error.name === 'NotAllowedError') {
                updateStatus('camera', 'Permission Denied', 'warning');
                updateStatus('mic', 'Permission Denied', 'warning');
            } else {
                updateStatus('camera', 'Not Available', 'error');
                updateStatus('mic', 'Not Available', 'error');
            }
        }
    } else {
        updateStatus('camera', 'Not Supported', 'error');
        updateStatus('mic', 'Not Supported', 'error');
    }
    
    // Check network
    if (navigator.onLine) {
        updateStatus('network', 'Online', 'success');
    } else {
        updateStatus('network', 'Offline', 'error');
    }
}

function updateStatus(type, status, level) {
    const statusElement = document.getElementById(type + 'Status');
    const iconElement = document.getElementById(type + 'Icon');
    
    statusElement.textContent = status;
    
    // Update colors based on level
    const colors = {
        success: { bg: 'bg-green-100', text: 'text-green-800', icon: 'text-green-600' },
        warning: { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: 'text-yellow-600' },
        error: { bg: 'bg-red-100', text: 'text-red-800', icon: 'text-red-600' }
    };
    
    const color = colors[level] || colors.error;
    
    statusElement.className = `text-lg font-bold ${color.text}`;
    iconElement.className = `${color.bg} rounded-full p-3 mr-4`;
    iconElement.querySelector('i').className = `fas fa-${getIconName(type)} ${color.icon} text-xl`;
}

function getIconName(type) {
    const icons = {
        webrtc: 'video',
        camera: 'camera',
        mic: 'microphone',
        network: 'wifi'
    };
    return icons[type] || 'question';
}

async function loadUserData() {
    try {
        const response = await fetch('/test-video-call');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('providersCount').textContent = data.data.providers_count || 0;
            document.getElementById('callsCount').textContent = data.data.calls_count || 0;
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        document.getElementById('providersCount').textContent = 'Error';
        document.getElementById('callsCount').textContent = 'Error';
    }
}

function getBrowserInfo() {
    // Browser name
    const userAgent = navigator.userAgent;
    let browserName = 'Unknown';
    
    if (userAgent.includes('Chrome')) browserName = 'Chrome';
    else if (userAgent.includes('Firefox')) browserName = 'Firefox';
    else if (userAgent.includes('Safari')) browserName = 'Safari';
    else if (userAgent.includes('Edge')) browserName = 'Edge';
    
    document.getElementById('browserName').textContent = browserName;
    document.getElementById('platformName').textContent = navigator.platform;
    document.getElementById('screenRes').textContent = `${screen.width}x${screen.height}`;
    
    // Connection type
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    document.getElementById('connectionType').textContent = connection ? connection.effectiveType : 'Unknown';
}

async function runSystemTest() {
    const testResults = document.getElementById('testResults');
    testResults.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i><p>Running system tests...</p></div>';
    
    const tests = [];
    
    // Test 1: WebRTC Support
    tests.push({
        name: 'WebRTC Support',
        status: window.RTCPeerConnection ? 'PASS' : 'FAIL',
        message: window.RTCPeerConnection ? 'WebRTC is supported' : 'WebRTC is not supported'
    });
    
    // Test 2: Media Devices
    try {
        await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        tests.push({
            name: 'Media Devices',
            status: 'PASS',
            message: 'Camera and microphone access granted'
        });
    } catch (error) {
        tests.push({
            name: 'Media Devices',
            status: 'FAIL',
            message: `Media access failed: ${error.message}`
        });
    }
    
    // Test 3: Network Connectivity
    try {
        const response = await fetch('/get-providers');
        tests.push({
            name: 'Network Connectivity',
            status: response.ok ? 'PASS' : 'FAIL',
            message: response.ok ? 'Server connectivity successful' : 'Server connectivity failed'
        });
    } catch (error) {
        tests.push({
            name: 'Network Connectivity',
            status: 'FAIL',
            message: 'Network request failed'
        });
    }
    
    // Display results
    testResults.innerHTML = tests.map(test => `
        <div class="flex items-center justify-between p-4 border rounded-lg ${test.status === 'PASS' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
            <div class="flex items-center">
                <i class="fas fa-${test.status === 'PASS' ? 'check-circle text-green-600' : 'times-circle text-red-600'} text-xl mr-3"></i>
                <div>
                    <h4 class="font-medium">${test.name}</h4>
                    <p class="text-sm text-gray-600">${test.message}</p>
                </div>
            </div>
            <span class="px-3 py-1 text-sm font-medium rounded-full ${test.status === 'PASS' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${test.status}
            </span>
        </div>
    `).join('');
}

async function testProviderSelection() {
    try {
        const response = await fetch('/get-providers');
        const data = await response.json();
        
        if (data.success && data.providers.length > 0) {
            alert(`✅ Provider selection test passed!\n\nFound ${data.providers.length} available providers:\n${data.providers.map(p => `• ${p.name}`).join('\n')}`);
        } else {
            alert('⚠️ No providers found. Please contact your administrator.');
        }
    } catch (error) {
        alert('❌ Provider selection test failed. Please check your connection.');
    }
}

async function testMediaDevices() {
    document.getElementById('mediaTestModal').classList.remove('hidden');
    
    try {
        testStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('testVideo').srcObject = testStream;
        
        // Setup audio level monitoring
        setupAudioMonitoring();
    } catch (error) {
        alert('Failed to access camera/microphone: ' + error.message);
        closeMediaTest();
    }
}

function setupAudioMonitoring() {
    if (testStream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(testStream);
        source.connect(analyser);
        
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function updateAudioLevel() {
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                const percentage = (average / 255) * 100;
                document.getElementById('audioLevel').style.width = percentage + '%';
                requestAnimationFrame(updateAudioLevel);
            }
        }
        
        updateAudioLevel();
    }
}

function toggleTestVideo() {
    if (testStream) {
        const videoTrack = testStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            document.getElementById('toggleVideo').innerHTML = videoTrack.enabled ? 
                '<i class="fas fa-video"></i> Toggle Video' : 
                '<i class="fas fa-video-slash"></i> Toggle Video';
        }
    }
}

function toggleTestAudio() {
    if (testStream) {
        const audioTrack = testStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            document.getElementById('toggleAudio').innerHTML = audioTrack.enabled ? 
                '<i class="fas fa-microphone"></i> Toggle Audio' : 
                '<i class="fas fa-microphone-slash"></i> Toggle Audio';
        }
    }
}

function closeMediaTest() {
    document.getElementById('mediaTestModal').classList.add('hidden');
    
    if (testStream) {
        testStream.getTracks().forEach(track => track.stop());
        testStream = null;
    }
    
    if (audioContext) {
        audioContext.close();
        audioContext = null;
        analyser = null;
    }
}
</script>
{% endblock %}
